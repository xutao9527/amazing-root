<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>æµå¼æ’­æ”¾</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f5f5f5; }
    video { border: 1px solid #ccc; border-radius: 8px; }
  </style>
</head>
<body>
<video id="video" controls autoplay muted width="640" height="360"></video>

<script>
  const video = document.getElementById("video");
  const mediaSource = new MediaSource();
  video.src = URL.createObjectURL(mediaSource);

  const mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
  let sourceBuffer;
  let segmentIndex = 1;

  mediaSource.addEventListener("sourceopen", async () => {
    console.log("ğŸ”“ MediaSource opened");
    sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);

    // ç¬¬ä¸€æ­¥åŠ è½½åˆå§‹åŒ–æ®µ
    const initSegment = await fetch("static/test_h264_dashinit.mp4").then(r => r.arrayBuffer());
    sourceBuffer.addEventListener("updateend", loadNextSegment, { once: true });
    sourceBuffer.appendBuffer(initSegment);
  });

  async function loadNextSegment() {
    const url = `static/test_h264_dash${segmentIndex}.m4s`;
    try {
      const resp = await fetch(url);
      if (!resp.ok) {
        if (resp.status === 404) {
          console.log(`âœ… æ‰€æœ‰åˆ†ç‰‡åŠ è½½å®Œæˆï¼ˆå…± ${segmentIndex - 1} æ®µï¼‰`);
          setTimeout(() => {
            if (mediaSource.readyState === "open") {
              mediaSource.endOfStream(); // å¯é€‰ï¼šé˜²æ­¢å‡ºç°ç³Šå±
            }
          }, 100);
          return;
        } else {
          throw new Error(`ç½‘ç»œé”™è¯¯: ${resp.status}`);
        }
      }
      const segment = await resp.arrayBuffer();
      if (!sourceBuffer.updating) {
        sourceBuffer.addEventListener("updateend", loadNextSegment, { once: true });
        sourceBuffer.appendBuffer(segment);
        console.log(`ğŸ“¦ åŠ è½½ç¬¬ ${segmentIndex} æ®µ`);
        segmentIndex++;
      } else {
        console.warn("âš ï¸ sourceBuffer è¿˜åœ¨ updatingï¼Œä¸¢å¼ƒè¯¥æ®µ");
      }
    } catch (err) {
      console.error("âŒ åŠ è½½åˆ†ç‰‡å‡ºé”™:", err);
    }
  }
</script>
</body>
</html>
