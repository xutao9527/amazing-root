<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>æµå¼æ’­æ”¾</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; background: #f5f5f5; }
        video { border: 1px solid #ccc; border-radius: 8px; }
    </style>
</head>
<body>

<img id="viewImg" alt="å›¾ç‰‡å°†å‡ºç°åœ¨è¿™é‡Œ"/>
<video id="video" controls autoplay muted width="640" height="360"></video>
<script type="module">
    import init,{decode_unicode} from "./wasm/amazing_wasm.js";
    await init();
    async function viewImg() {

        const response = await fetch('https://cdn.jsdelivr.net/npm/amazing-data/12179.txt');
        const text = await response.text();
        const byteArray = decode_unicode(text);
        const blob = new Blob([byteArray], { type: 'image/jpeg' });
        const url = URL.createObjectURL(blob);
        const img = document.getElementById('viewImg');
        img.src = url;
    }


    viewImg().catch(err => {
        console.error("è§£ç å¤±è´¥:", err);
    });

    const video = document.getElementById("video");
    const mediaSource = new MediaSource();
    video.src = URL.createObjectURL(mediaSource);

    const mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
    let sourceBuffer;
    let segmentIndex = 1;

    mediaSource.addEventListener("sourceopen", async () => {
        console.log("ğŸ”“ MediaSource opened");
        sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);

        // ç¬¬ä¸€æ­¥åŠ è½½åˆå§‹åŒ–æ®µ
        const response = await fetch("https://cdn.jsdelivr.net/npm/amazing-data/test_dashinit.txt");
        const text = await response.text();

        const byteArray = decode_unicode(text);

        sourceBuffer.addEventListener("updateend", loadNextSegment, { once: true });
        sourceBuffer.appendBuffer(byteArray);
    });

    async function loadNextSegment() {
        const url = `https://cdn.jsdelivr.net/npm/amazing-data/test_dash${segmentIndex}.txt`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                if (response.status === 404) {
                    console.log(`âœ… æ‰€æœ‰åˆ†ç‰‡åŠ è½½å®Œæˆï¼ˆå…± ${segmentIndex - 1} æ®µï¼‰`);
                    setTimeout(() => {
                        if (mediaSource.readyState === "open") {
                            mediaSource.endOfStream(); // å¯é€‰ï¼šé˜²æ­¢å‡ºç°ç³Šå±
                        }
                    }, 100);
                    return;
                } else {
                    throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
                }
            }
            const text = await response.text();
            const byteArray = decode_unicode(text);

            if (!sourceBuffer.updating) {
                sourceBuffer.addEventListener("updateend", loadNextSegment, { once: true });
                sourceBuffer.appendBuffer(byteArray);
                console.log(`ğŸ“¦ åŠ è½½ç¬¬ ${segmentIndex} æ®µ`);
                segmentIndex++;
            } else {
                console.warn("âš ï¸ sourceBuffer è¿˜åœ¨ updatingï¼Œä¸¢å¼ƒè¯¥æ®µ");
            }
        } catch (err) {
            console.error("âŒ åŠ è½½åˆ†ç‰‡å‡ºé”™:", err);
        }
    }
</script>
</body>
</html>
